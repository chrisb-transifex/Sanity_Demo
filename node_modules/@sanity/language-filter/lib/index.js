"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react/jsx-runtime"),t=require("react"),n=require("sanity"),s=require("@sanity/icons"),l=require("@sanity/ui"),a=require("styled-components");const r=(e,t,n)=>!e.name.startsWith("locale")||n.includes(t.name);function i(e,t){var n,s;const l=function(e){return"object"===(null==e?void 0:e.jsonType)&&"document"===o(e).name}(e)&&(null==(n=null==e?void 0:e.options)?void 0:n.languageFilter),a=!t.documentTypes;return!!(a&&!1!==l||!a&&l||e&&null!=(s=t.documentTypes)&&s.includes(e.name))}function o(e){return e.type?o(e.type):e}const u="@sanity/plugin/language-filter/selected-languages";function c(e){const t=d(e).map((e=>e.id));let n=t;try{const e=window.localStorage.getItem(u);e&&(n=JSON.parse(e))}catch{}return s=t,n=n.filter((e=>s.includes(e))),n;var s}function d({supportedLanguages:e,defaultLanguages:t}){return Array.isArray(e)?e.filter((e=>!(null!=t&&t.includes(e.id)))):[]}const g={options:{apiVersion:"2022-11-27",supportedLanguages:[],defaultLanguages:[],documentTypes:[],filterField:r},selectedLanguageIds:[],setSelectedLanguageIds:()=>console.error("LanguageFilterStudioContext not initialized")},p=t.createContext(g);function f(s){const l=n.useClient({apiVersion:"2023-01-01"}),[a,r]=t.useState(Array.isArray(s.options.supportedLanguages)?s.options.supportedLanguages:[]);t.useEffect((()=>{let e=[];Array.isArray(s.options.supportedLanguages)||async function(t){e=await t(l,{}),r(e)}(s.options.supportedLanguages)}),[l,s.options.supportedLanguages]);const i=t.useMemo((()=>({...g.options,...s.options,supportedLanguages:a})),[s.options,a]),[o,u]=function(e){return t.useState((()=>{var t;return[...null!=(t=e.defaultLanguages)?t:[],...c(e)]}))}(i);return e.jsx(p.Provider,{value:{options:i,selectedLanguageIds:o,setSelectedLanguageIds:u},children:s.renderDefault(s)})}function x(){return t.useContext(p)}const m=e=>Array.from(new Set(e));function h(){const{selectedLanguageIds:e,setSelectedLanguageIds:n,options:s}=x(),{defaultLanguages:l=[]}=s,a=t.useMemo((()=>d(s)),[s]),r=t.useCallback((e=>{var t;n(m([...l,...e])),t=m([...l,...e]),window.localStorage.setItem(u,JSON.stringify(t))}),[l,n]),i=t.useCallback((()=>r(a.map((e=>e.id)))),[r,a]),o=t.useCallback((()=>{r(l)}),[l,r]),c=t.useCallback((t=>{let n=e;n=n.includes(t)?n.filter((e=>e!==t)):m([...n,t]),r(n)}),[r,e]);return{activeLanguages:t.useMemo((()=>m([...null!=l?l:[],...e])),[l,e]),allSelected:e.length===a.length+l.length,selectAll:i,selectNone:o,toggleLanguage:c}}const j=a.styled(l.Box)`
  max-height: calc(100vh - 200px);
`;function L(){const{options:a}=x(),r=a.supportedLanguages.filter((e=>{var t;return null==(t=a.defaultLanguages)?void 0:t.includes(e.id)})),i=a.supportedLanguages.filter((e=>{var t;return!(null!=(t=a.defaultLanguages)&&t.includes(e.id))})),[o,u]=t.useState(!1),{activeLanguages:c,allSelected:d,selectAll:g,selectNone:p,toggleLanguage:f}=h(),[m,L]=t.useState(null),[S,C]=t.useState(null),T=t.useCallback((e=>{"ALL"===e.currentTarget.value?g():p()}),[g,p]),b=t.useCallback((()=>u((e=>!e))),[]),v=t.useCallback((()=>u(!1)),[]);l.useClickOutside(v,[m,S]);const k=a.supportedLanguages.length,[F,I]=t.useState(""),w=t.useCallback((e=>{e.currentTarget.value?I(e.currentTarget.value):I("")}),[]),A=k>4,B=e.jsx(j,{overflow:"auto",children:e.jsxs(l.Stack,{padding:1,space:1,children:[r.length>0&&e.jsxs(e.Fragment,{children:[r.map((t=>e.jsx(y,{id:t.id,title:t.title,selected:!0},t.id))),e.jsx(l.Card,{borderTop:!0})]}),e.jsx(l.Button,{mode:"bleed",onClick:T,justify:"flex-start",value:d?"NONE":"ALL",disabled:!!F,children:e.jsxs(l.Flex,{gap:3,align:"center",children:[e.jsx(l.Text,{size:2,children:d?e.jsx(n.TextWithTone,{tone:"primary",children:e.jsx(s.EyeClosedIcon,{})}):e.jsx(s.EyeOpenIcon,{})}),e.jsx(l.Box,{flex:1,children:e.jsx(l.Text,{children:d?"Hide all":"Show all"})})]})}),A?e.jsx(l.TextInput,{onChange:w,value:F,placeholder:"Filter languages"}):e.jsx(l.Card,{borderTop:!0}),i.filter((e=>!F||e.title.toLowerCase().includes(F.toLowerCase()))).map((t=>e.jsx(y,{id:t.id,onToggle:f,selected:c.includes(t.id),title:t.title},t.id)))]})}),O=c.length===k?"Showing all":`Showing ${c.length} / ${k}`;return e.jsx(l.Popover,{animate:!0,content:B,open:o,portal:!0,ref:C,children:e.jsx(l.Button,{text:O,icon:s.TranslateIcon,mode:"bleed",onClick:b,ref:L,selected:o})})}function y(a){const{id:r,onToggle:i,selected:o,title:u}=a,c=t.useCallback((()=>{i&&i(r)}),[r,i]),d=!i;return e.jsx(l.Button,{mode:"bleed",onClick:c,justify:"flex-start",disabled:d,children:e.jsxs(l.Flex,{gap:3,align:"center",children:[e.jsx(l.Text,{size:2,children:o?e.jsx(n.TextWithTone,{tone:d?"default":"positive",children:e.jsx(s.CheckmarkCircleIcon,{})}):e.jsx(s.CircleIcon,{})}),e.jsx(l.Box,{flex:1,children:e.jsx(l.Text,{children:u})}),e.jsx(l.Badge,{children:r})]})})}function S(e){const{members:n,schemaType:s,renderDefault:l,...a}=e,{selectedLanguageIds:r,options:i}=x(),{filterField:o}=i;return l({...a,members:t.useMemo((()=>n.filter((e=>"field"===e.kind&&o(s,e,r)||"fieldSet"===e.kind)).map((e=>"fieldSet"===e.kind?{...e,fieldSet:{...e.fieldSet,members:e.fieldSet.members.filter((e=>"field"===e.kind&&o(s,e,r)))}}:e))),[s,n,o,r]),schemaType:s,renderDefault:l})}const C=n.definePlugin((t=>{const s=()=>e.jsx(L,{}),l={...g.options,...t};return{name:"@sanity/language-filter",studio:{components:{layout:e=>f({...e,options:l})}},document:{unstable_languageFilter:(e,{schemaType:n,schema:l})=>i(l.get(n),t)?[...e,s]:e},form:{components:{input:t=>"root"!==t.id&&n.isObjectSchemaType(t.schemaType)?function(t){const{options:s}=x(),l=n.useFormValue(["_type"]);return i(n.useSchema().get(l),s)?e.jsx(S,{...t}):t.renderDefault(t)}(t):t.renderDefault(t)}}}}));exports.defaultFilterField=r,exports.isLanguageFilterEnabled=i,exports.languageFilter=C,exports.useLanguageFilterStudioContext=x;//# sourceMappingURL=index.js.map
